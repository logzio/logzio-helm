apiVersion: apps/v1
kind: Deployment
metadata:
  name: signalfx-gen
  labels:
    app: signalfx-gen
spec:
  replicas: 1
  selector:
    matchLabels:
      app: signalfx-gen
  template:
    metadata:
      labels:
        app: signalfx-gen
    spec:
      initContainers:
        - name: wait-for-collector
          image: busybox:1.36
          command: ["/bin/sh"]
          args:
            - -c
            - |
              ENV_ID=${ENV_ID:-default-env}
              RELEASE_NAME=${RELEASE_NAME:-logzio-k8s-telemetry}
              NAMESPACE=${NAMESPACE:-default}
              COLLECTOR_HOST="${RELEASE_NAME}-otel-collector.${NAMESPACE}.svc.cluster.local"
              echo "Waiting for SignalFx receiver to be ready at $COLLECTOR_HOST:9943..."
              until nc -z $COLLECTOR_HOST 9943; do
                echo "Collector not ready, waiting 5 seconds..."
                sleep 5
              done
              echo "SignalFx receiver is ready!"
          env:
            - name: ENV_ID
              value: "${ENV_ID}"
            - name: RELEASE_NAME
              value: "logzio-k8s-telemetry"
            - name: NAMESPACE
              value: "default"
      containers:
        - name: signalfx-gen
          image: curlimages/curl:8.6.0
          command: ["/bin/sh"]
          args:
            - -c
            - |
              ENV_ID=${ENV_ID:-default-env}
              RELEASE_NAME=${RELEASE_NAME:-logzio-k8s-telemetry}
              NAMESPACE=${NAMESPACE:-default}
              COLLECTOR_HOST="${RELEASE_NAME}-otel-collector.${NAMESPACE}.svc.cluster.local"
              
              # Send SignalFx metrics continuously
              while true; do
                # Decode the pre-built protobuf payload
                echo "$B64_PAYLOAD" | base64 -d > /tmp/payload.pb
                
                # Send the protobuf request
                http_code=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Content-Type: application/x-protobuf" \
                  --data-binary @/tmp/payload.pb \
                  "http://$COLLECTOR_HOST:9943/v2/datapoint")
                
                # Log the result
                if [ "$http_code" = "200" ] || [ "$http_code" = "202" ]; then
                  echo "SignalFx metric sent successfully (HTTP $http_code)"
                else
                  echo "SignalFx metric failed (HTTP $http_code)"
                fi
                
                # Wait 30 seconds before sending the next metric
                sleep 30
              done
          env:
            - name: ENV_ID
              value: "${ENV_ID}"
            - name: RELEASE_NAME
              value: "logzio-k8s-telemetry"
            - name: NAMESPACE
              value: "default"
            - name: B64_PAYLOAD
              value: "CjASGnRlc3Quc2lnbmFsZnguY29ubmVjdGl2aXR5GNumiaSGMyIJEQAAAAAAAPA/KAA=" 